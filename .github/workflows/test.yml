name: AIMER PRO - Tests et Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.9, 3.10, 3.11]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements_web.txt
    
    - name: Test imports
      run: |
        python -c "from core.detector import SmartDetector; print('‚úÖ SmartDetector import OK')"
        python -c "from core.config import ConfigManager; print('‚úÖ ConfigManager import OK')"
        python -c "from core.logger import Logger; print('‚úÖ Logger import OK')"
    
    - name: Test webcam simulation
      run: |
        # Test sans vraie webcam (CI environment)
        python -c "
        import cv2
        print('‚úÖ OpenCV import OK')
        try:
            cap = cv2.VideoCapture(0)
            print('‚úÖ VideoCapture creation OK')
            cap.release()
        except Exception as e:
            print(f'‚ö†Ô∏è  VideoCapture test: {e} (normal en CI)')
        "
    
    - name: Syntax check
      run: |
        python -m py_compile ui/web_interface/server.py
        python -m py_compile launch.py
        python -m py_compile test_webcam.py
        echo "‚úÖ Tous les fichiers Python compilent correctement"
    
    - name: Structure validation
      run: |
        echo "üìÅ Validation de la structure unifi√©e..."
        test -f "ui/web_interface/server.py" && echo "‚úÖ Serveur unique pr√©sent"
        test -f "launch.py" && echo "‚úÖ Lanceur unique pr√©sent"
        test -f "ui/web_interface/templates/index.html" && echo "‚úÖ Interface unique pr√©sente"
        test -f "test_webcam.py" && echo "‚úÖ Test webcam pr√©sent"
        
        # V√©rifier qu'il n'y a plus de doublons
        ! test -f "ui/web_interface/server_ultimate.py" && echo "‚úÖ Anciens serveurs supprim√©s"
        ! test -f "launch_ultimate_fixed.py" && echo "‚úÖ Anciens lanceurs supprim√©s"
        
        echo "üéØ Structure nettoy√©e et unifi√©e !"
