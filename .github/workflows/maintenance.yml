name: ğŸš€ AIMER - Maintenance Intelligente
# Workflow automatisÃ© pour maintenir le projet AIMER
# Explication pour nÃ©ophytes incluse

on:
  # DÃ©clenche le workflow sur plusieurs Ã©vÃ©nements
  push:
    branches: [ main, alpha, dev ]
  pull_request:
    branches: [ main, alpha ]
  schedule:
    # VÃ©rification automatique tous les lundis Ã  9h
    - cron: '0 9 * * 1'
  workflow_dispatch:
    # Permet de lancer manuellement le workflow

jobs:
  # === JOB 1: AUDIT DE SÃ‰CURITÃ‰ ===
  security-audit:
    name: ğŸ”’ Audit de SÃ©curitÃ©
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ RÃ©cupÃ©ration du code
      uses: actions/checkout@v4
      
    - name: ğŸ Configuration Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ğŸ›¡ï¸ Scan de sÃ©curitÃ© avec Bandit
      run: |
        pip install bandit[toml]
        bandit -r . -f json -o security-report.json || true
        
    - name: ğŸ“Š Scan des dÃ©pendances vulnÃ©rables
      run: |
        pip install safety
        safety check --json --output safety-report.json || true
        
    - name: ğŸ“‹ Rapport de sÃ©curitÃ©
      run: |
        echo "ğŸ”’ RAPPORT DE SÃ‰CURITÃ‰ AIMER" >> $GITHUB_STEP_SUMMARY
        echo "==========================" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Scan terminÃ©" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“ Rapports gÃ©nÃ©rÃ©s:" >> $GITHUB_STEP_SUMMARY
        echo "- security-report.json" >> $GITHUB_STEP_SUMMARY
        echo "- safety-report.json" >> $GITHUB_STEP_SUMMARY

  # === JOB 2: QUALITÃ‰ DU CODE ===
  code-quality:
    name: ğŸ“ QualitÃ© du Code
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ RÃ©cupÃ©ration du code
      uses: actions/checkout@v4
      
    - name: ğŸ Configuration Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ğŸ“¦ Installation des outils de qualitÃ©
      run: |
        pip install flake8 black isort mypy
        
    - name: ğŸ¨ VÃ©rification du formatage (Black)
      run: |
        black --check --diff . || echo "âš ï¸ Code mal formatÃ© dÃ©tectÃ©"
        
    - name: ğŸ“‹ VÃ©rification du style (Flake8)
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        
    - name: ğŸ”„ VÃ©rification des imports (isort)
      run: |
        isort . --check-only --diff || echo "âš ï¸ Imports mal triÃ©s dÃ©tectÃ©s"
        
    - name: ğŸ” Analyse de types (MyPy)
      run: |
        mypy . --ignore-missing-imports || echo "âš ï¸ ProblÃ¨mes de types dÃ©tectÃ©s"

  # === JOB 3: DOCUMENTATION ===
  documentation:
    name: ğŸ“š VÃ©rification Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ RÃ©cupÃ©ration du code
      uses: actions/checkout@v4
      
    - name: âœ… VÃ©rification README.md
      run: |
        if [ -f "README.md" ]; then
          echo "âœ… README.md prÃ©sent"
          wc -l README.md
        else
          echo "âŒ README.md manquant"
          exit 1
        fi
        
    - name: ğŸ“‹ VÃ©rification des commentaires
      run: |
        echo "ğŸ“Š STATISTIQUES DE DOCUMENTATION" >> $GITHUB_STEP_SUMMARY
        echo "================================" >> $GITHUB_STEP_SUMMARY
        
        # Compter les lignes de code et commentaires
        TOTAL_LINES=$(find . -name "*.py" -exec wc -l {} + | tail -1 | awk '{print $1}')
        COMMENT_LINES=$(find . -name "*.py" -exec grep -c "^[[:space:]]*#" {} + | awk '{sum+=$1} END {print sum}')
        
        echo "ğŸ“ Lignes de code total: $TOTAL_LINES" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ’¬ Lignes de commentaires: $COMMENT_LINES" >> $GITHUB_STEP_SUMMARY
        
        if [ $COMMENT_LINES -gt 0 ]; then
          RATIO=$((COMMENT_LINES * 100 / TOTAL_LINES))
          echo "ğŸ“Š Ratio commentaires: $RATIO%" >> $GITHUB_STEP_SUMMARY
        fi

  # === JOB 4: PERFORMANCE & MAINTENANCE ===
  maintenance:
    name: ğŸ”§ Maintenance Automatique
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: ğŸ“¥ RÃ©cupÃ©ration du code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ Configuration Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ğŸ”„ Mise Ã  jour des dÃ©pendances
      run: |
        pip install pip-tools
        pip-compile requirements_security.txt --upgrade || echo "Pas de requirements Ã  compiler"
        
    - name: ğŸ§¹ Nettoyage automatique
      run: |
        # Supprimer les fichiers temporaires
        find . -name "*.pyc" -delete
        find . -name "__pycache__" -type d -exec rm -rf {} + || true
        find . -name "*.log" -delete || true
        
    - name: ğŸ“Š GÃ©nÃ©ration du rapport de maintenance
      run: |
        echo "ğŸ”§ RAPPORT DE MAINTENANCE AIMER" > MAINTENANCE_REPORT.md
        echo "===============================" >> MAINTENANCE_REPORT.md
        echo "" >> MAINTENANCE_REPORT.md
        echo "ğŸ“… Date: $(date)" >> MAINTENANCE_REPORT.md
        echo "ğŸ—ï¸ Branche: ${{ github.ref_name }}" >> MAINTENANCE_REPORT.md
        echo "" >> MAINTENANCE_REPORT.md
        
        echo "## ğŸ“Š Statistiques du projet" >> MAINTENANCE_REPORT.md
        echo "- **Fichiers Python**: $(find . -name "*.py" | wc -l)" >> MAINTENANCE_REPORT.md
        echo "- **Lignes de code**: $(find . -name "*.py" -exec wc -l {} + | tail -1 | awk '{print $1}')" >> MAINTENANCE_REPORT.md
        echo "- **Taille du repo**: $(du -sh . | cut -f1)" >> MAINTENANCE_REPORT.md
        echo "" >> MAINTENANCE_REPORT.md
        
        echo "## ğŸ”§ Actions effectuÃ©es" >> MAINTENANCE_REPORT.md
        echo "- âœ… Nettoyage des fichiers temporaires" >> MAINTENANCE_REPORT.md
        echo "- âœ… VÃ©rification de la structure" >> MAINTENANCE_REPORT.md
        echo "- âœ… Audit de sÃ©curitÃ©" >> MAINTENANCE_REPORT.md
        
    - name: ğŸ’¾ Commit des changements automatiques
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if [ -n "$(git status --porcelain)" ]; then
          git add .
          git commit -m "ğŸ¤– Maintenance automatique - $(date +%Y-%m-%d)"
          git push
        else
          echo "Aucun changement Ã  committer"
        fi

  # === JOB 5: NOTIFICATION SUMMARY ===
  summary:
    name: ğŸ“‹ RÃ©sumÃ© Final
    runs-on: ubuntu-latest
    needs: [security-audit, code-quality, documentation]
    if: always()
    
    steps:
    - name: ğŸ“Š GÃ©nÃ©ration du rÃ©sumÃ©
      run: |
        echo "# ğŸš€ RAPPORT AIMER - Maintenance Intelligente" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“‹ Statut des vÃ©rifications" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Statut de chaque job
        echo "| Job | Statut |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ”’ SÃ©curitÃ© | ${{ needs.security-audit.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ“ QualitÃ© | ${{ needs.code-quality.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ“š Documentation | ${{ needs.documentation.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ğŸ’¡ Explication pour nÃ©ophytes" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Ce workflow automatise la maintenance de votre projet AIMER :**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ”’ **SÃ©curitÃ©** : VÃ©rifie qu'il n'y a pas de vulnÃ©rabilitÃ©s" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“ **QualitÃ©** : S'assure que le code respecte les bonnes pratiques" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“š **Documentation** : VÃ©rifie que le projet est bien documentÃ©" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ”§ **Maintenance** : Nettoie et met Ã  jour automatiquement" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ¤– **Ce systÃ¨me maintient votre projet en bonne santÃ© automatiquement !**"
